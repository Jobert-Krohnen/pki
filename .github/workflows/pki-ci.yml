name: PKI CI
on: [push, pull_request]

jobs:
  acme-tests:
    needs: build
    uses: ./.github/workflows/acme-tests.yml

  build:
    uses: ./.github/workflows/build.yml
    secrets: inherit

  ca-tests:
    needs: build
    uses: ./.github/workflows/ca-tests.yml
    with:
      repo: ${{ needs.call-build-workflow.outputs.repo }}
      db-image: ${{ needs.call-build-workflow.outputs.db-image }}

  ca-tests2:
    needs: build
    uses: ./.github/workflows/ca-tests2.yml
    with:
      repo: ${{ needs.call-build-workflow.outputs.repo }}
      db-image: ${{ needs.call-build-workflow.outputs.db-image }}

  code-analysis:
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    uses: ./.github/workflows/code-analysis.yml
    secrets: inherit

  ipa-tests:
    needs: build
    uses: ./.github/workflows/kra-tests.yml
    with:
      db-image: ${{ needs.call-build-workflow.outputs.db-image }}

  kra-tests:
    needs: build
    uses: ./.github/workflows/kra-tests.yml
    with:
      db-image: ${{ needs.call-build-workflow.outputs.db-image }}

  ocsp-tests:
    needs: build
    uses: ./.github/workflows/ocsp-tests.yml
    with:
      db-image: ${{ needs.call-build-workflow.outputs.db-image }}

  python-tests:
    uses: ./.github/workflows/python-tests.yml

  qe-tests:
    needs: build
    uses: ./.github/workflows/qe-tests.yml

  server-tests:
    needs: build
    uses: ./.github/workflows/server-tests.yml

  tks-tests:
    needs: build
    uses: ./.github/workflows/tks-tests.yml
    with:
      db-image: ${{ needs.call-build-workflow.outputs.db-image }}

  tools-tests:
    needs: build
    uses: ./.github/workflows/tools-tests.yml

  tps-tests:
    needs: build
    uses: ./.github/workflows/tps-tests.yml
    with:
      db-image: ${{ needs.call-build-workflow.outputs.db-image }}
